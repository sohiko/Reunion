# Phase 1：要件定義の確定（修正版）

## 同窓会サポートWebアプリケーション設計書

---

## 1. プロジェクト概要

### 1.1 背景と目的

本プロジェクトは、同窓会の運営を効率化し、卒業生同士のつながりを維持・強化するためのWebアプリケーションを開発することを目的としている。同窓会役員が約10名弱という小規模な体制で運営されることを考慮し、限られた人的リソースでも効果的な運用が可能なシステム設計を採用する。加えて、個人情報保護への配慮を最優先事項として位置づけ、個人情報保護法（APPI）に完全準拠した仕組みを構築する。

本アプリケーションの核心的な価値提案は、卒業生が自らの連絡先情報を自律的に管理しながらも、幹事や役員が円滑に連絡網を維持できる点にある。従来のExcelファイルや紙の名簿による管理では、情報の更新不及时性やセキュリティリスクが課題となっていた。本システムでは、本人確認による信頼性の担保、同意に基づく情報開示フロー、そして包括的な監査ログにより、これらの課題を解決する。

### 1.2 対象ユーザーと優先順位

本システムの利用者は大きく5つのカテゴリに分類される。同窓会役員は全体の統括運営を担当し、全学年の会員への一斉送信や管理機能の利用が期待される。幹事は学年ごとの担当として、担当学年の会員検索・送信・削除操作を行いながら連絡網の中核を担う。一般会員である卒業生本人は、自分の情報の管理と他の卒業生とのつながり維持为主要な利用目的とする。教員は各学年への一斉送信という限定的な機能を利用するが、パスワード変更や退会、自分のプロファイル編集も可能とする。システム管理者は技術的な運用と障害対応を担当するが、原則として個人情報の閲覧は行わない前提で設計する。

機能優先順位としては、第一にイベント告知（学年別および全体）を実現し、第二にメンバーの連絡先保存・更新機能を整備する。第三に連絡がつかない人との再接続仕組みを構築し、第四に役員向けの管理機能と専用連絡機能を実装する。会費徴収機能は本フェーズでは範囲外とする。

---

## 2. ユースケース一覧

### 2.1 システム管理者（System Administrator）のユースケース

システム管理者は技術基盤の維持管理を担当する立場であり、その権限は必要最小限に制限される。システム管理者として実行可能な操作は、サーバー・データベースの監視と障害対応、基本設定情報の変更、および緊急時のデータ保全措置である。重要な点として、システム管理者は会員の個人情報や連絡先を閲覧・取得することは原則として認められない。これは「最小権限の原則」に基づく設計であり、万が一の不正アクセスや内部犯行による情報漏洩リスクを根本から遮断するものである。

システム管理者が行う設定変更や障害対応においても、実行者認証と操作ログの取得は必須とする。これにより、操作の正当性を事後的に検証可能な状態を維持する。ただし、これらの監査ログへのアクセスは役員にのみ許可し、システム管理者自身も自らの操作ログを削除できない設計とする。

### 2.2 同窓会役員（Officer）のユースケース

同窓会役員は本システムの最上位権限ユーザーとして、卒業生との長期的な信頼関係の維持に責任を持つ立場である。役員が実行可能なユースケースは多岐にわたる。会員管理においては、全学年の会員一覧表示、全会員の詳細情報閲覧、および会員情報の編集・更新が可能である。連絡機能としては、全会員または学年別の一斉メール送信、SMS送信、およびアプリ内メッセージの一斉配信が認められる。

イベント管理では、新規イベントの作成・編集・削除、全会員への告知配信、およびイベントのキャンセルや日程変更通知を担当する。身分証閲覧については、全会員の身分証明書画像を閲覧・審査する権限を有する。検索機能については、全学年を対象とした会員検索が許可されるが、これには必ず検索理由の入力と役員承認が必要となり、詳細な監査ログが記録される。管理機能としては、他の役員・幹事の権限付与・変更、幹事の担当学年設定、および退会・削除依頼の審査と実行が含まれる。

### 2.3 幹事（Class Coordinator）のユースケース

幹事は特定学年の運営を担当する中核的なユーザーであり、担当学年に関する広範な権限を有しながらも、他の学年へのアクセスは制限される。幹事の会員管理機能は、担当学年の会員一覧表示、担当会員の詳細情報閲覧、および会員情報の編集・更新である。幹事と役員の違いは、全学年ではなく担当学年のみにアクセス可能という点にある。

幹事の一斉送信機能は、担当学年へのメール・SMS・アプリ内メッセージの一斉配信を含む。退会・削除操作については、担当学年の会員に対する退会処理や名簿からの削除が可能である。連絡先閲覧については、幹事は担当学年の会員連絡先を許可なしで閲覧できるが、これは会員登録時に幹事への情報提供に同意している前提に基づく。ただし、身分証画像の閲覧は幹事には許可されず、役員のみが閲覧可能とする。幹事が閲覧した記録はすべて監査ログに記録され、後日の検証が可能となる。

イベント作成については、担当学年を対象としたイベントの新規作成・編集・削除が可能である。これにより、幹事は自らの担当学年について主体的にイベントを企画・実施することができる。

### 2.4 一般会員（General Member）のユースケース

一般会員は卒業生本人であり、自らの情報管理と他の卒業生とのつながり維持为主要な利用目的となる。一般会員の基本操作として、プロフィール情報（氏名、住所、メール、電話など）の閲覧・編集、連絡先情報の更新、およびプライバシ設定の変更が可能である。学生検索については、原則として同学年の会員のみを検索でき、他学年の会員は検索できない設計とする。

一般会員間の連絡先共有は、許可申請と承認のプロセスを経ることで実現される。ある会員が別の会員の連絡先閲覧を申請し、相手がこれを承認した場合に限り、連絡先情報が共有される。個別メッセージ機能により、他の会員への直接的なコミュニケーションが可能であるが、受信者は送信者をブロックする権限を有する。イベント関連では、イベント一覧の閲覧と出欠登録・更新、およびイベントの詳細情報確認が認められる。

### 2.5 教員（Teacher）のユースケース

教員は各学年への一斉送信という限定的な機能を持つユーザーであるが、アカウント管理や自己プロファイル編集の権限も有する。教員は卒業生ではないため、名簿への登録は行わず、ログイン認証のみで利用可能な状態となる。

教員が行える操作として、各学年へのメール・SMS・アプリ内メッセージの一斉配信、およびイベント告知の閲覧が可能である。自己プロファイル管理として、自己の氏名や連絡先情報などの閲覧・編集、パスワード変更、および退会手続きも可能とする。連絡先閲覧許可申請については、他の会員に対して連絡先閲覧の申請を行うことは可能であるが、教員自体が卒業生の連絡先を閲覧することは認められていない。

教員が会員情報を閲覧したり、個別のメッセージを送信したりすることは認められていない。教員アカウントの作成・削除は役員のみが行えるものとし、教員自身もアカウント作成を申請する形式を採用する。

---

## 3. 権限マトリクス

### 3.1 ロール別機能アクセス権

本システムの権限管理は、ロールベースアクセス制御（RBAC）を基本としつつ、一部の機能については属性ベースアクセス制御（ABAC）を組み合わせたハイブリッド方式を採用する。以下の表は、各ロールの機能アクセス権を体系的に示したものである。

| 機能カテゴリ | 機能 | 一般会員 | 幹事 | 役員 | 教員 | システム管理者 |
|------------|------|:--------:|:----:|:----:|:----:|:-------------:|
| **認証・アカウント** | 新規登録 | ○ | ○ | ○ | ○ | × |
| | ログイン | ○ | ○ | ○ | ○ | × |
| | パスワード変更 | ○ | ○ | ○ | ○ | × |
| | アカウント削除（退会） | ○ | ○ | ○ | ○ | × |
| **プロフィール管理** | 自己プロファイル閲覧 | ○ | ○ | ○ | ○ | × |
| | 自己プロファイル編集 | ○ | ○ | ○ | ○ | × |
| | 他会員プロファイル閲覧（氏名・卒業年のみ） | △ | ○ | ○ | × | × |
| | 他会員プロファイル閲覧（全情報） | × | ○（担当学年） | ○（全学年） | × | × |
| **本人確認** | 身分証アップロード | ○ | ○ | ○ | × | × |
| | 身分証閲覧 | × | × | ○（全学年） | × | × |
| | 本人確認承認 | × | × | ○ | × | × |
| **連絡先管理** | 自己連絡先閲覧・編集 | ○ | ○ | ○ | ○ | × |
| | 他会員連絡先閲覧 | × | ○（担当学年・同意済） | ○（同意済） | × | × |
| | 連絡先閲覧許可申請 | ○ | ○ | ○ | ○ | × |
| | 連絡先閲覧許可承認・拒否 | ○ | ○ | ○ | × | × |
| **検索機能** | 同学年会員検索 | ○ | ○ | ○ | × | × |
| | 全学年会員検索 | × | × | ○ | × | × |
| | 全学年検索理由入力・承認 | × | × | ○ | × | × |
| **連絡機能** | アプリ内メッセージ（個別） | ○ | ○ | ○ | × | × |
| | アプリ内メッセージ（一斉） | × | ○（担当学年） | ○（全学年） | ○（各学年） | × |
| | メール送信（一斉） | × | ○（担当学年） | ○（全学年） | ○（各学年） | × |
| | SMS送信（一斉） | × | ○（担当学年） | ○（全学年） | ○（各学年） | × |
| | 郵送ラベル出力 | × | ○（担当学年） | ○（全学年） | × | × |
| **イベント管理** | イベント一覧閲覧 | ○ | ○ | ○ | ○ | × |
| | イベント作成・編集・削除 | × | ○（担当学年） | ○（全学年・全対象） | × | × |
| | 出欠登録・更新 | ○ | ○ | ○ | × | × |
| | 出欠状況閲覧 | ○ | ○ | ○ | × | × |
| **管理機能** | 会員承認・却下 | × | × | ○ | × | × |
| | 権限付与・変更 | × | × | ○ | × | × |
| | 幹事担当学年設定 | × | × | ○ | × | × |
| | 削除依頼対応 | × | ○（担当学年） | ○（全学年） | × | × |
| | 監査ログ閲覧 | × | ○（担当学年） | ○（全学年） | × | × |
| | 監査ログ閲覧（全学年） | × | × | ○ | × | × |
| | データエクスポート | × | × | ○ | × | × |
| **システム運用** | サーバー監視・障害対応 | × | × | × | × | ○ |
| | 設定変更 | × | × | × | × | ○ |
| | バックアップ実行 | × | × | × | × | ○ |
| | 復元処理 | × | × | × | × | ○ |

凡例：○＝可能、×＝不可、△＝条件付き可能

### 3.2 閲覧範囲の詳細ルール

会員情報の閲覧は、情報の機微性に応じた段階的なアクセス制御を実施する。第一段階として、氏名と卒業年は基本的な検索・一覧表示で公開される情報であるが、会員本人が設定により非表示にすることも可能である。第二段階として、旧姓と学生番号は幹事以上のみが閲覧可能とし、一般会員同士の閲覧は認めない。

第三段階として、現住所、メールアドレス、電話番号は本人同意なしでは一般会員に表示されない。幹事と役員については、会員登録時に幹事・役員への情報提供に同意しているため、許可なく閲覧可能とする。ただし、幹事による閲覧は担当学年のみに制限される。教員は連絡先閲覧の申請を行うことは可能であるが、閲覧権限自体は持たない。第四段階として、身分証明書画像については、幹事には閲覧権限がなく、役員のみが一時的な署名付きURLを通じて閲覧可能とし、本人確認作業終了後は速やかに削除または匿名化処理を行う。

### 3.3 全学年検索の特別な承認フロー

役員が全学年を対象とした会員検索を行う場合、通常の権限では認めない特別な承認プロセスを実施する。まず、役員は検索理由を明示的に入力する。入力が必要な情報は、検索目的（例：イベント告知のため連絡が必要、特定の会員の所在確認など）、検索対象の範囲（卒業年、氏名の一部など）、および検索実施者の正当性確認である。

入力された検索理由は、他の役員による承認を必要とする。承認者となった役員は、入力された理由の妥当性を審査し、承認または却下を行う。承認が行われた場合のみ検索が実行され、検索内容と結果（何件のデータがヒットしたか）はすべて監査ログに記録される。検索理由に虚偽や不審な点がある場合、承認者は検索を却下し、その旨を理由を付して記録することができる。

---

## 4. データモデル

### 4.1 会員（Users）エンティティ

会員の基本情報を管理するエンティティであり、認証情報とアカウント状態を管理する。usersテーブルには、固有の識別子としてuuid型のidを設定し、主キーとして運用する。認証情報として、email VARCHAR(255) UNIQUE NOT NULLを設定し、password_hash VARCHAR(255) NOT NULLにはbcryptでハッシュ化されたパスワードを格納する。

アカウント状態を示すstatusフィールドは、PENDING（承認待ち）、ACTIVE（承認済み）、SUSPENDED（停止中）、DELETED（削除済み）の4つの値を取り得る。created_atとupdated_atはタイムスタンプとして必須項目とし、last_login_atは最終ログイン日時を記録する。agreed_terms_versionとagreed_privacy_versionは、利用規約とプライバシーポリシーの同意バージョンを記録し、agreed_terms_atとagreed_privacy_atは同意日時を記録する。role_idは外部キーとしてrolesテーブルとの関連付けに使用する。

### 4.2 会員プロファイル（Profiles）エンティティ

会員の詳細なプロファイル情報を管理するエンティティであり、usersテーブルと1対1で関連付ける。profilesテーブルのidはusersテーブルのidと同一とし、結合主キーとして運用する。氏名情報は、name_sei（姓）とname_mei（名）をそれぞれVARCHAR(100)として保存する。旧姓情報は、maiden_name VARCHAR(100) NULLABLEとして設定する。

卒業情報は、graduation_year INTEGER NOT NULL（例：1990）とstudent_number VARCHAR(50) NULLABLE（学生番号）を含む。連絡先情報はすべて暗号化対象として扱う。address TEXT NULLABLEにはAES-256-GCMで暗号化された住所を格納し、email VARCHAR(255) NULLABLE、phone_number VARCHAR(50) NULLABLEも同様に暗号化する。display_settingsはJSONB型とし、氏名表示設定（is_name_visible BOOLEAN DEFAULT TRUE）、検索結果表示設定（is_searchable BOOLEAN DEFAULT TRUE）、表示範囲設定（display_scope：public、classmates_only、private）などの会員のプライバシー設定を保存する。

### 4.3 身分証明書（VerificationDocuments）エンティティ

本人確認のための身分証明書画像を管理するエンティティである。idはuuid型の主キーとし、user_idはusersテーブルへの外部キーとして関連付ける。file_path VARCHAR(500) NOT NULLには、オブジェクトストレージ上のファイルパスを保存する。original_filename VARCHAR(255) NOT NULLは元のファイル名を記録するが、セキュリティのため画面表示時には匿名化する。

statusフィールドはUPLOADED（アップロード済み）、PENDING_REVIEW（審査待ち）、APPROVED（承認済み）、REJECTED（否認）、DELETED（削除済み）の値を取る。uploaded_atはアップロード日時、reviewed_atは審査日時、reviewed_byは審査を行った役員のuser_idを保存する。reviewer_notes TEXT NULLABLEには審査時のメモを記録する。expires_atは的身分証明書データの有効期限を示し、承認完了後または一定期間経過後に自動削除する処理に使用する。

### 4.4 ロール（Roles）エンティティ

ユーザーの権限グループを定義するエンティティである。rolesテーブルのidはuuid型の主キーとし、name VARCHAR(50) UNIQUE NOT NULLでロール名（GENERAL_MEMBER、OFFICER、COORDINATOR、TEACHER、SYSTEM_ADMIN）を保存する。description TEXTはロールの説明を記述する。permissions JSONBは該ロールが持つ権限のリストをJSON形式で保存する。

### 4.5 同意履歴（ConsentRecords）エンティティ

ユーザーの同意履歴を追跡するエンティティである。idはuuid型の主キーとし、user_idはusersテーブルへの外部キーとする。consent_typeはTERMS_OF_SERVICE、PRIVACY_POLICY、DATA_PROCESSING、THIRD_PARTY_SHARINGなどの同意種別を示す。consent_versionは同意したポリシーのバージョンを記録し、consent_given_atは同意日時を示す。ip_addressとuser_agentは同意時の接続情報を保存し、consent_withdrawn_atは同意撤回日時を記録する。

### 4.6 監査ログ（AuditLogs）エンティティ

システム上のすべての重要な操作を記録するエンティティである。idはuuid型の主キーとし、user_idは操作を行ったユーザーのID（NULLの場合はシステム自動実行など）を保存する。actionはACTION_TYPE列挙型（VIEW、SEARCH、UPDATE、DELETE、EXPORT、LOGIN、LOGOUT、UPLOAD、DOWNLOAD、APPROVE、REJECT、SEND_MESSAGEなど）を取る。resource_typeは対象となるリソースの種類（USER、PROFILE、EVENT、MESSAGE、CONTACT、DOCUMENTなど）を示し、resource_idは対象リソースのIDを保存する。

details JSONBには操作の詳細情報（検索理由、変更前後の値など）を保存する。ip_addressとuser_agentは操作時の接続情報を記録し、requires_approvalは承認が必要な操作かどうかのフラグ、approval_statusは承認状態（APPROVED、PENDING、REJECTED、NOT_REQUIRED）を示す。approved_byとapproved_atは承認者情報と承認日時を保存する。created_atはログ作成日時を示す。

### 4.7 連絡先開示リクエスト（ContactAccessRequests）エンティティ

一般会員間での連絡先開示申請を管理するエンティティである。idはuuid型の主キーとし、requester_id（申請者）とtarget_id（対象者）はusersテーブルへの外部キーとする。statusはPENDING、PENDING_APPROVAL、APPROVED、REJECTED、EXPIRED、CANCELLEDの値を取る。requested_contact_typesはJSONB型で、申請した連絡先種別のリスト（email、phone、address）を保存する。

reason TEXT NOT NULLには申請理由を記述する。respondent_notified_atは対象者への通知日時を記録し、respondent_response_atは対象者の回答日時を示す。notify_on_reject BOOLEANは拒否時に申請者に通知するかどうかの設定であり、block_future_requests BOOLEANは今後この申請者からのリクエストをブロックするかどうかの設定である。expires_atはリクエストの有効期限を示し、created_atは作成日時を記録する。

### 4.8 開示履歴（ContactAccessLogs）エンティティ

連絡先が開示された履歴を管理するエンティティである。idはuuid型の主キーとし、viewer_id（閲覧者）とsubject_id（対象者）はusersテーブルへの外部キーとする。access_typeはDIRECT_VIEW（直接閲覧）、EMAIL_SENT（メール送付）、LABEL_GENERATED（ラベル生成など）を示す。contact_typeはEMAIL、PHONE、ADDRESSのいずれかを示し、access_methodはWEB_VIEW、DOWNLOAD、EXPORTなどのアクセス方法を記録する。

details JSONBには詳細情報（メール送信先など）を保存する。access_granted_byは承認者（対象者本人または幹事・役員など）を示し、ip_addressとuser_agentはアクセス時の接続情報を記録する。created_atはアクセス日時を示す。

### 4.9 イベント（Events）エンティティ

同窓会イベントを管理するエンティティである。idはuuid型の主キーとし、title VARCHAR(200) NOT NULLでイベント名を保存する。description TEXT NULLABLEにはイベントの詳細説明を記述する。event_typeはREUNION（同窓会）、MEETING（役員会）、ANNOUNCEMENT（告知など）の値を取る。event_date TIMESTAMP NOT NULLはイベント日時を示し、location TEXT NULLABLEは開催場所を保存する。target_graduation_yearsはINTEGER[]型で対象卒業年のリストを保存し、is_all_graduates BOOLEANは卒業生全体を対象とするかどうかを示す。

statusはSCHEDULED、PUBLISHED、CANCELLED、COMPLETED、ARCHIVEDの値を取り、created_byはイベント作成者のuser_idである。created_atとupdated_atはタイムスタンプを記録する。

### 4.10 出欠（Attendances）エンティティ

イベントへの参加・不参加を記録するエンティティである。idはuuid型の主キーとし、event_idはeventsテーブルへの外部キー、user_idはusersテーブルへの外部キーとする。statusはPENDING、ATTENDING、NOT_ATTENDING、WAITLISTEDの値を取る。additional_notes TEXT NULLABLEには参加者からのメモを記録する。responded_atは回答日時を示し、created_atとupdated_atはタイムスタンプを記録する。

### 4.11 メッセージ（Messages）エンティティ

アプリ内メッセージを管理するエンティティである。idはuuid型の主キーとし、sender_idは送信者のuser_id、recipient_idは受信者のuser_idを示す。conversation_id VARCHAR(50) NULLABLEは会話スレッドの識別子であり、スレッド形式のメッセージングに使用する。content TEXT NOT NULLはメッセージ本文であり、is_read BOOLEANは既読フラグ、read_atは既読日時を示す。message_typeはINDIVIDUAL（個別）、GROUP（グループ）、ANNOUNCEMENT（一斉告知）を示す。sender_deleted_atとrecipient_deleted_atは削除フラグとして機能し、created_atは送信日時を記録する。

### 4.12 幹事担当学年（CoordinatorAssignments）エンティティ

幹事の担当学年を管理するエンティティである。idはuuid型の主キーとし、coordinator_idはusersテーブルへの外部キー（幹事ユーザー）、graduation_year INTEGER NOT NULLは担当卒業年を示す。assigned_byは割り当てを行った役員のuser_id、assigned_atは割り当て日時を記録する。

---

## 5. 重要フローのシーケンス

### 5.1 ユーザー登録・承認フロー

新規ユーザーが本システムを利用するためには、身分証明書による本人確認を経て、役員による承認を得る必要がある。このプロセスは複数のステップで構成され、セキュリティと信頼性を担保するための設計となっている。

第一步として、ユーザーは登録ページにアクセスし、基本情報（氏名、メールアドレス、パスワード、卒業年など）を入力する。入力完了後、システムは利用規約とプライバシーポリシーの同意確認を行い、同意がない場合は登録を完了できない。同意後、システムは入力されたメールアドレスに確認メールを送信し、メールアドレスの所有確認を行う。

第二步として、ユーザーが確認メールのリンクをクリックし、仮登録が完了する。この段階でユーザーはログイン可能となるが、アカウントステータスはPENDING（承認待ち）となる。ユーザーは次に、身分証明書の画像をアップロードする。アップロードされた画像は一時保存され、元のファイル名は破棄され、推測困難なUUIDでリネームされる。

第三歩として、アップロード完了後、ユーザーは登録情報を確認し、送信完了画面が表示される。役員（またはシステム）に対して本人確認依頼の通知が送信される。役員は管理画面から身分証明書を確認し、画像に写っている情報と登録情報が一致するか検証する。検証結果は、APPROVED（承認済み）、PENDING_REVIEW（再審査）、REJECTED（否認）のいずれかに更新される。

第四歩として、承認された場合、ユーザーのステータスがACTIVEに変更され、すべての機能が利用可能となる。否認された場合、ユーザーは否認理由の通知を受け、再登録または情報の修正を行うことができる。90日間ステータスがPENDINGのままである場合、アカウントは自動的に削除され、身分証明書データも同時に削除される。

### 5.2 連絡先開示許可申請フロー

一般会員が他の会員の連絡先を閲覧するためには、相手方の許可を得る必要がある。このプロセスは、プライバシーを保護しながら必要な情報共有を可能にする設計となっている。

第一歩として、申請者は対象者の会員詳細ページにアクセスし、「連絡先閲覧許可申請」ボタンをクリックする。申請フォームが表示され、申請理由の入力と、閲覧したい連絡先種別の選択（メールアドレス、電話番号、住所など）を行う。送信後、システムは申請を受領し、対象者への通知準備を行う。

第二步として、システムは対象者に対してメールおよびSMS（登録されている場合）で通知を送信する。通知には申請者の氏名・卒業年、申請理由、閲覧したい連絡先種別、および承認・拒否のリンクが含まれる。対象者はリンクをクリックし、ログイン後に申請詳細を確認し、承認または拒否の判断を行う。

第三歩として、対象者が「承認」を選択した場合、承認者自身が提供を希望する連絡先情報を選択する画面が表示される。対象者は、提供を希望しない情報種目のチェックを外すことができ、最終確認後に承認を完了する。システムはこの承認を記録し、申請者に承認通知を送信する。

第四歩として、申請者は連絡先情報を閲覧可能な状態となる。閲覧方法は、申請で選択された連絡先種別に応じて、ウェブ画面での閲覧、またはメールでの送付のいずれかとなる。申請者の監査ログには、いつ、誰の、どの連絡先情報にアクセスしたかが記録される。連絡先情報は、直接画面に表示する場合と、メールで送付する場合のいずれかを選択可能とし、どちらも監査ログに記録される。

第五歩として、対象者が「拒否」を選択した場合、システムは拒否を記録する。拒否通知の送信有無は、対象者が拒否時に選択できる設定項目とする。対象者は、将来の当該申請者からのリクエストをブロックする設定を行うことも可能である。ブロック設定がある場合、当該申請者からの今後すべての申請は自動的に拒否される。

### 5.3 全学年検索承認フロー

役員が全学年の会員を検索する場合、通常の権限を超えた操作となるため、特別な承認プロセスを経る必要がある。

第一歩として、役員は検索ページから「全学年検索モード」を選択する。システムは検索理由入力フォームを表示し、役員は検索目的（例：イベント告知、特定会員の所在確認など）と検索範囲を入力する。入力完了後、「承認申請」ボタンをクリックして申請を送信する。

第二步として、システムは他の役員（または指定された承認者）に対して承認依頼通知を送信する。承認者は管理画面から保留中の承認申請一覧を確認し、申請詳細（検索理由、検索範囲、申請者）を確認する。承認者は検索理由の妥当性を審査し、承認または却下を行う。

第三歩として、承認者が「承認」を選択した場合、検索が実行可能となる。検索結果には何件のデータがヒットしたかが表示され、申請者とその検索結果の閲覧はすべて監査ログに記録される。検索理由と承認結果（承認者、承認日時）も一緒に記録される。却下された場合、申請者には却下理由が通知され、検索は実行されない。

### 5.4 退会・削除依頼フロー

会員が退会を希望する場合、または名簿からの削除を依頼する場合の対応フローである。

第一歩として、会員は「設定」ページから「退会申請」ボタンをクリックする。退会理由を入力するフォームが表示され、退会後のデータ取り扱い（名的からの削除、完全なデータ消去など）についての説明を確認した上で申請を送信する。システムは退会依頼を記録し、該当会員のステータスをPENDING_DELETIONに変更する。

第二步として、役員（担当学年の幹事または役員）に対して退会依頼の通知が送信される。役員は依頼詳細を確認し、必要に応じて会員に連絡を取り、退会の意思を確認する。確認後、役員は退会を承認または拒否する。

第三歩として、退会が承認された場合、システムは会員の個人情報を段階的に処理する。まず、退会者本人にデータエクスポートの提供を行う。次に、身分証明書画像を削除する。その後、会員テーブルとプロファイルテーブルのデータを匿名化（氏名：「退会用」、メールアドレス：「deleted-uuid@example.com」の形式）または完全に削除する。すべての削除操作は監査ログに記録される。削除完了後、会員には通知が送信される。

### 5.5 イベント告知・出欠フロー

同窓会イベントの作成から告知、出欠管理までのフローである。

第一步として、役員または幹事はイベント管理ページから「新規イベント作成」を選択する。イベントの基本情報（タイトル、説明、日時、場所、対象学年など）を入力し、「下書き保存」または「公開」を選択する。幹事がイベントを作成する場合、対象学年は担当学年のみ選択可能とする。入力内容を確認し、公開すると対象学年の会員にイベント告知が送信される。

第二步として、会員はイベント一覧から詳細を確認し、参加・不参加の意思を登録する。出欠登録は各イベントの页面から行える。役員はリアルタイムで出欠状況を確認できる。

第三歩として、イベント日程接近に伴い、リマインダーが自動送信される。イベント終了後、役員はイベントを「完了」状態に遷移させ、参加者リストをCSVでエクスポートすることが可能である。参加者リストの取得は監査ログに記録される。

---

## 6. リスク一覧と対策

### 6.1 個人情報漏洩リスク

本システムにおいて最も重大なリスクは、卒業生や関係者の個人情報漏洩である。漏洩経路としては、外部からの不正アクセス、内部関係者による不正持出し、アプリケーションの脆弱性を突いた攻撃、データバックアップからの漏洩などが考えられる。

対策として、技術面ではデータベースの機微情報カラム（住所、メール、電話など）をAES-256-GCMで暗号化して保存する。暗号化鍵は環境変数で管理し、ソースコードや設定ファイルには含めない。通信はすべてHTTPS（TLS 1.2以上）を必須とし、証明書の有効期限監視を行う。身分証明書画像はオブジェクトストレージに格納し、直接URLアクセスを禁止する。閲覧時には有効期限付き署名付きURL（Presigned URL）を発行し、5分以内に無効化する。

運用面では、管理者アカウントの多要素認証を必須とし、定期的なパスワード変更を促す。監査ログへのアクセス権限は最小限とし、ログの改ざん・削除を物理的に不可能にする設計とする。定期的な脆弱性診断とペネトレーションテストを実施し、発見された脆弱性は速やかに修正する。バックアップデータは暗号化して保管し、復元テストを定期的に実施する。

### 6.2 なりすましリスク

悪意ある第三者が他人の身份成りすましてアカウントを作成し、情報を不正に取得するリスクがある。特に、同窓会という性質上、卒業年や氏名などの情報が比較的容易に推測可能なため、风险が高い。

対策として、身分証明書による本人確認を必須とし、役員による目視確認プロセスを設ける。身分証明書に登録されている情報と入力された情報を照合し、不一致がある場合は承認を保留する。IP地址や地理位置情報を監視し、通常とは異なるアクセスパターンを検知した場合は追加の認証を求める。ログイン失敗回数に上限を設け、一定回数を超えるとアカウントをロックする。

### 6.3 権限逸脱リスク

幹事や役員が своих権限を超えて情報にアクセスしたり、操作したりするリスクがある。例えば、担当学年以外の会員情報を閲覧する、全学年検索を正当な理由なく頻繁に行う、監査ログを改ざんするなどの行為が考えられる。

対策として、権限制御はサーバーサイドで厳格に実装し、クライアント側のチェックはすべて辅助的なものとして扱う。すべてのデータアクセス、操作を監査ログに記録し、後日の検証を可能にする。監査ログ自体へのアクセスも制限し、管理者であっても削除・改ざんをできない設計とする。全学年検索は毎回承認プロセスを経る必要があり、承認者自身も記録される。定期的なアクセスログレビューを実施し、異常なパターンを検知した場合は調査を行う。身分証閲覧は幹事には許可されていないため、この点も厳格に制御する。

### 6.4 データ消失・损坏リスク

ハードウェア障害、人為的誤操作、自然災害などによりデータが失われるリスクがある。90年間のデータ保持が要件であるため、長期的なデータ保全が重要となる。

対策として、定期的なデータベースバックアップを実施し、バックアップデータは地理的に離れた場所に保管する。バックアップからの復元手順を文書化し、定期的に復元テストを実施して手順の有効性を確認する。データベースの冗長化（レプリケーション）を可能な範囲で実施し、単一障害点を排除する。論理削除を採用し、误って削除したデータの恢复を可能にする設計とする。自動削除jobsは削除前に複数の确认步骤を設け、误動作を防止する。

### 6.5 無料運用に関する制約リスク

予算0円の制約により、有料サービスの利用が制限され、以下の制約が生じる可能性がある。

データベース容量については、Supabaseの無料枠は500MBまでのため、データ量の増加に伴い上限に達するリスクがある。対策として、不要なデータの定期的な削除（古い監査ログの圧縮・归档など）、画像ファイルの圧縮、身分証明書承認後の速やかな削除を実施する。容量使用量をモニタリングし、閾値超過前にアラートを設定する。

メール送信については、SendGridの無料枠は1日100通までのため、大規模なイベント告知時に上限を超えるリスクがある。対策として、メールの批量送信を避け、複数日に分散させる。メールではなくアプリ内通知を優先的に使用する。緊急連絡先はSMSや電話 fallback を準備する。SendGridの有料プランへの升级 criteriasを事前に定義する。

サーバー可用性については、RenderやRailwayの無料枠は一定時間の非アクティブ後にインスタンスが停止するため、アクセス時に遅延が生じるリスクがある。対策として、定期的なhealth check pingを送信し、インスタンスの停止を防止する。 пользователиに対しては、维护窗口を事前に通知する。关键機能（登录、密码レストなど）を別の轻量なサービスに分离する。

### 6.6 法的リスク（個人情報保護法抵触）

個人情報保護法（APPI）に違反するリスクとして、利用目的を超えたデータ利用、本人からの削除請求への対応漏れ、第三者提供時の同意取得漏れなどが考えられる。

対策として、利用目的を明確化し、利用規約とプライバシーポリシーに明記する。同意取得の記録を保存し、後日の証跡提供を可能にする。本人からの削除請求（利用停止、消除請求）に対応するフローを構築し、受付から対応完了までのプロセスを文書化する。データ取扱いの全工程で同意を取得し、同意の撤回にも対応する。定期的なlegal reviewを実施し、法令改正に対応する。

---

## 7. プライバシー設計

### 7.1 プライバシー・バイ・デザインの原則

本システムは、プライバシー・バイ・デザインの原則に基づき設計する。これは、製品やサービスの開発段階からプライバシーを組み込むという考え方であり、事後的な追加や修正では十分な保護が実現できないという認識に基づいている。

具体的な実装として、データの収集は必要最小限にとどめ、収集するデータには必ず利用目的を明示する。デフォルトでは最も厳しいプライバシー設定とし、ユーザーが明示的に選択した場合のみ情報公開範囲を広げる。データ処理の透明性を確保し、ユーザーが自身のデータがどのように扱っているかを随时確認できるようにする。セキュリティ対策を標準機能として組み込み、追加のセットアップを必要としない設計とする。

### 7.2 同意管理の設計

ユーザーの同意は、法的要件の充足であると同時に、サービスの信頼性を維持するための重要な要素である。同意管理の設計においては、複数の要素を考慮する必要がある。

同意の粒度として、利用規約への同意、プライバシーポリシーの同意、データの処理への同意、第三者提供への同意など、項目ごとに分割して同意を取得する。同意の版本管理として、ポリシーの версияごとに同意状態を記録し、バージョンアップ時には再同意を求める。同意の撤回として、ユーザーはいつでも同意を撤回でき、撤回後は当該データ処理を停止する。同意の記録として、いつ、誰が、どのような条件下で同意したかをすべて記録し、証跡として保存する。

### 7.3 データ主体の権利対応

個人情報保護法に基づき、データ主体（本人）が有する権利を保障する設計とする。

利用停止請求として、本人から自らのデータの利用停止を求められた場合、速やかに当該データの利用を停止する。消除請求として、本人から自らのデータの消除を求められた場合、法令上の保存義務期間を経過したデータは速やかに消除する。データポータビリティとして、本人から自らのデータの导出を求められた場合、汎用的なフォーマット（JSON、CSVなど）で提供する。異議申立として、自動化された Decision-making に対する異議を申し立てる手段を提供する。

これらの請求に対応する管理画面とワークフローを構築し、請求受付から対応完了までの履歴を記録する。

---

## 8. 次のステップ

本ドキュメント（Phase 1：要件定義の確定）では、同窓会サポートWebアプリケーションの要件定義を完了した。次回のPhase 2では、技術的な方式設計を行い、具体的な技術スタックの選定とアーキテクチャ設計を提示する。

Phase 2で扱う主要なトピックは以下の通りである。無料枠中心のスタック提案として、各レイヤーで採用する技術と無料枠での運用可能性の評価を行う。認証・認可方式として、JWTベースの認証実装、RBAC/ABACハイブリッド認可の設計、監査ログの詳細仕様を策定する。暗号化方針として、保存時・通信時の暗号化方式、鍵管理方法、身分証画像の安全な取り扱いを設計する。メール・SMS送信方式として、免费枠での現実的な運用、fallback戦略、段階的導入計画を策定する。バックアップ・復元設計として、定期バックアップの設計、復元手順の文書化、90年自動削除jobsの実装方式を確定する。

これらの設計を経て、Phase 3以降で実際の実装を進めることになる。

Phase2実行結果は [@tech.md] に記載。

---

以上